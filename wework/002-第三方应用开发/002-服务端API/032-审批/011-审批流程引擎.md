---
title: "审批流程引擎"
doc_id: 14627
category_id: 93798
source_url: https://developer.work.weixin.qq.com/document/path/93798
---
最后更新：2020/01/13

[TOC]

## 概述
企业微信向开发者提供审批流程引擎。
开发者可在第三方应用中直接调用接口发起审批申请，系统根据审批流程自动通知相关人员进行审批操作。
提交申请后审批流程的每次状态变化，都会通知开发者，可按需进行拓展开发。
- ![第三方应用审批流程引擎示意图](http://p.qpic.cn/pic_wework/3060163285/484efd44c2c5dbe7d7cc4828217143809b095b07f5d660ab/0 "第三方应用审批流程引擎示意图")

##1.创建第三方应用审批模板

开发者可在“服务商后台-标准应用服务-网页应用-应用详情-审批接口”中，创建审批模板。
用户在安装第三方应用后，可在“企业管理后台-应用与小程序-应用详情”中，设置审批流程。

**功能说明：**

| 参数 | 说明 |
| ------------ | ------------ |
| 模板ID | 用于审批申请类型区分。在后续发起审批申请时，将申请和审批流程进行关联。在开发者创建审批模板时生成。 |
| 审批流程 | 审批流程相关配置。后续以此模板ID发起的审批申请，都将按照设置的流程进行通知和流转。由企业用户在管理后台应用详情处设置。 |

## 2.第三方应用发起审批

通过JS-SDK，可在第三方应用中发起审批。[查看JS-SDK调用详细说明](https://work.weixin.qq.com/api/doc#10029 "查看JS-SDK调用详细说明")
具体步骤：
1.通过config接口注入权限验证配置。[查看](https://work.weixin.qq.com/api/doc#10029/%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E9%80%9A%E8%BF%87config%E6%8E%A5%E5%8F%A3%E6%B3%A8%E5%85%A5%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE "查看注入说明")
2.通过agentConfig注入应用的权限。[查看](https://work.weixin.qq.com/api/doc#10029/%E9%80%9A%E8%BF%87agentConfig%E6%B3%A8%E5%85%A5%E5%BA%94%E7%94%A8%E7%9A%84%E6%9D%83%E9%99%90 "查看注入说明")
3.调用审批流程引擎JS-API。[查看](https://work.weixin.qq.com/api/doc#10029/%E5%AE%A1%E6%89%B9%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E6%8E%A5%E5%8F%A3"[查看调用说明")

**请求示例：**
```javascript
wx.invoke('thirdPartyOpenPage', {
 "oaType": "10001",// String
 "templateId": "46af67a118a6ebf000002",// String
 "thirdNo": "thirdNo",// String
 "extData": {
 'fieldList': [{
 'title': '采购类型',
 'type': 'text',
 'value': '市场活动',
 },
 {
 'title': '订单链接',
 'type': 'link',
 'value': 'https://work.weixin.qq.com',
 }],
 }
},
function(res) {
 // 输出接口的回调信息
 console.log(res);
});
```
**参数说明：**

| 参数 | 必须 | 说明 |
| ------------ | ------------ |
| oaType | 是 | 操作类型，目前支持：10001-发起审批；10002-查看审批详情。 |
| templateId | 是 |发起审批的模板ID，在第三方应用-审批接口中创建模板可获取。 |
| thirdNo | 是 | 审批单号，由开发者自行定义，不可重复。 |
| extData | 是 | 详情数据，Json格式，用于审批详情页信息展示。|

**extData数据说明：**
extData在发起时由开发者传入，其中数据将全部展示在审批申请中：
1.开发者可利用此特性，在发起审批时，传入需要申请人、审批人、抄送人看到的信息；
2.若需用户填写数据，可在自行使用表单收集，并传入exData中，用于展示。

``` javascript
{ 
 "extData": {
 'fieldList': [
 {
 'title': '采购类型',
 'type': 'text',
 'value': '市场活动',
 },
 {
 'title': '采购说明',
 'type': 'text',
 'value': '购买个人办公电脑',
 },
 {
 'title': '采购金额',
 'type': 'text',
 'value': '4839.00元',
 },
 {
 'title': '申请时间',
 'type': 'text',
 'value': '2018/06/20',
 },
 {
 'title': '订单链接',
 'type': 'link',    // link类型，用于在审批详情页展示第三方订单跳转地址
 'value': 'https://www.qq.com',
 },
 ],

 },
}
```
**参数说明：**

| 参数 | 必须 | 说明 |
| ------------ | ------------ | ------------ |
| title | 否 | 字段标题，将会在审批详情页中展示。 |
| type | 否 | 字段类型，目前支持：text-文本；link:链接。link仅展示在审批详情页。|
| value | 否 | 字段值，将会在审批详情页中展示。|

**错误说明：**

| 错误提示 | 说明 |
| ------------ | ------------ | ------------ |
| 已存在相同的审批编号 | oaType为10001时，传入的thirdNo已经被其他审批单占用。 |
| 审批申请不存在 | oaType为10002时，在历史记录中，传入的thirdNo对应的审批单不存在。|
| 审批模板ID不正确| 调用接口时传入了错误的templateId|
| 应用ID不正确|  使用了错误的 agentId|

## 3.第三方应用审批状态变化通知回调

开发者设置了“服务商后台-标准应用服务-网页应用-应用详情-数据回调URL”后，会收到审批状态通知事件。
第三方应用每一个审批申请的审批状态变化，都会通知给开发者。[查看事件回调详细说明](https://work.weixin.qq.com/api/doc#12974/%E5%AE%A1%E6%89%B9%E7%8A%B6%E6%80%81%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6 "查看事件回调详细说明")

**回调通知示例：**

```xml
<xml>
 <ToUserName>wwddddccc7775555aaa</ToUserName> 
 <FromUserName>sys</FromUserName> 
 <CreateTime>1527838022</CreateTime> 
 <MsgType>event</MsgType> 
 <Event>open_approval_change</Event>
 <AgentID>1</AgentID>
 <ApprovalInfo> 
 <ThirdNo>201806010001</ThirdNo> 
 <OpenSpName>付款</OpenSpName> 
 <OpenTemplateId>1234567890</OpenTemplateId> 
 <OpenSpStatus>1</OpenSpStatus> 
 <ApplyTime>1527837645</ApplyTime> 
 <ApplyUserName>jackiejjwu</ApplyUserName> 
 <ApplyUserId>WuJunJie</ApplyUserId> 
 <ApplyUserParty>产品部</ApplyUserParty> 
 <ApplyUserImage>http://www.qq.com/xxx.png</ApplyUserImage> 
 <ApprovalNodes> 
 <ApprovalNode> 
 <NodeStatus>1</NodeStatus> 
 <NodeAttr>1</NodeAttr> 
 <NodeType>1</NodeType> 
 <Items> 
 <Item> 
 <ItemName>chauvetxiao</ItemName> 
 <ItemUserid>XiaoWen</ItemUserid> 
 <ItemParty>产品部</ItemParty> 
 <ItemImage>http://www.qq.com/xxx.png</ItemImage> 
 <ItemStatus>1</ItemStatus> 
 <ItemSpeech></ItemSpeech> 
 <ItemOpTime>0</ItemOpTime> 
 </Item> 
 </Items> 
 </ApprovalNode> 
 </ApprovalNodes> 
 <NotifyNodes> 
 <NotifyNode> 
 <ItemName>jinhuiguo</ItemName> 
 <ItemUserid>GuoJinHui</ItemUserid> 
 <ItemParty>行政部</ItemParty> 
 <ItemImage>http://www.qq.com/xxx.png</ItemImage> 
 </NotifyNode> 
 </NotifyNodes> 
 <approverstep>0</approverstep> 
 </ApprovalInfo> 
</xml>

```
**参数说明：**

| 参数 | 说明 |
| ------------ | ------------ |
| ToUserName | 接收方企业Corpid |
| FromUserName | 发送方：企业微信|
| CreateTime | 消息发送时间 |
| MsgType | 消息类型|
| Event | 事件名称：审批状态变化|
| AgentID| 企业应用的id，整型。可在应用的设置页面查看|
| ApprovalInfo| 审批信息|
| ThirdNo | 审批单编号，由开发者在发起申请时自定义 |
| OpenSpName | 审批模板名称|
| OpenTemplateId | 审批模板id|
| OpenSpStatus | 申请单当前审批状态：1-审批中；2-已通过；3-已驳回；4-已取消|
| ApplyTime | 提交申请时间|
| ApplyUserName | 提交者姓名|
| ApplyUserId | 提交者userid|
| ApplyUserParty | 提交者所在部门|
| ApplyUserImage | 提交者头像 |
| ApprovalNodes | 审批流程信息 |
| ApprovalNode | 审批流程信息，可以有多个审批节点 |
| NodeStatus | 节点审批操作状态：1-审批中；2-已同意；3-已驳回；4-已转审|
| NodeAttr | 审批节点属性：1-或签；2-会签 |
| NodeType | 审批节点类型：1-固定成员；2-标签；3-上级|
| Items | 审批节点信息，当节点为标签或上级时，一个节点可能有多个分支 |
| Item | 审批节点分支，当节点为标签或上级时，一个节点可能有多个分支 |
| ItemName | 分支审批人姓名|
| ItemUserid | 分支审批人userid|
| ItemParty | 分支审批人所在部门|
| ItemImage | 分支审批人头像 |
| ItemStatus | 分支审批审批操作状态：1-审批中；2-已同意；3-已驳回；4-已转审 |
| ItemSpeech | 分支审批人审批意见 |
| ItemOpTime | 分支审批人操作时间 |
| NotifyNodes | 抄送信息，可能有多个抄送人 |
| NotifyNode | 抄送人信息 |
| ItemName | 抄送人姓名|
| ItemUserid | 抄送人userid|
| ItemParty | 抄送人所在部门|
| ItemImage | 抄送人头像 |
| approverstep | 当前审批节点：0-第一个审批节点；1-第二个审批节点…以此类推 |

##4.查询第三方应用审批申请当前状态

开发者也可主动查询审批单的当前审批状态。

**请求方式：** POST（**HTTPS**）
**请求地址：** https://qyapi.weixin.qq.com/cgi-bin/corp/getopenapprovaldata?access_token=ACCESS_TOKEN

**请求示例：**
```json
{
  "thirdNo": "201806010001"
}
```

**参数说明：**

| 参数 | 必须 | 说明 |
| ------------ | ------------ | ------------ |
| access_token | 是 | 调用接口凭证 |
| thirdNo | 是 | 开发者发起申请时定义的审批单号 |

**返回结果：**

```json
{
 "errcode": 0,
 "errmsg": "ok",
 "data": {
 "ThirdNo": "201806010001",
 "OpenTemplateId": "1234567890",
 "OpenSpName": "付款",
 "OpenSpstatus": 1,
 "ApplyTime": 1527837645,
 "ApplyUsername": "jackiejjwu",
 "ApplyUserParty": "产品部",
 "ApplyUserImage": "http://www.qq.com/xxx.png",
 "ApplyUserId": "WuJunJie",
 "ApprovalNodes": {
 "ApprovalNode": [
 {
 "NodeStatus": 1,
 "NodeAttr": 1,
 "NodeType": 1,
 "Items": {
 "Item": [
 {
 "ItemName": "chauvetxiao",
 "ItemParty": "产品部",
 "ItemImage": "http://www.qq.com/xxx.png",
 "ItemUserId": "XiaoWen",
 "ItemStatus": 1,
 "ItemSpeech": "",
 "ItemOpTime": 0
 }
 ]
 }
 }
 ]
 },
 "NotifyNodes": {
 "NotifyNode": [
 {
 "ItemName": "jinhuiguo",
 "ItemParty": "行政部",
 "ItemImage": "http://www.qq.com/xxx.png",
 "ItemUserId": "GuoJinHui"
 }
 ]
 },
 "approverstep": 0
 }
}
```

**参数说明：**

| 参数 | 说明 |
| ------------ | ------------ |
| ToUserName | 接收方企业Corpid |
| FromUserName | 发送方：企业微信|
| CreateTime | 消息发送时间 |
| MsgType | 消息类型|
| Event | 事件名称：审批状态变化|
| ApprovalInfo| 审批信息|
| ThirdNo | 审批单编号，由开发者在发起申请时自定义 |
| OpenSpName | 审批模板名称|
| OpenTemplateId | 审批模板id|
| OpenSpStatus | 申请单当前审批状态：1-审批中；2-已通过；3-已驳回；4-已取消|
| ApplyTime | 提交申请时间|
| ApplyUserName | 提交者姓名|
| ApplyUserId | 提交者userid|
| ApplyUserParty | 提交者所在部门|
| ApplyUserImage | 提交者头像 |
| ApprovalNodes | 审批流程信息 |
| ApprovalNode | 审批流程信息，可以有多个审批节点 |
| NodeStatus | 节点审批操作状态：1-审批中；2-已同意；3-已驳回；4-已转审|
| NodeAttr | 审批节点属性：1-或签；2-会签 |
| NodeType | 审批节点类型：1-固定成员；2-标签；3-上级|
| Items | 审批节点信息，当节点为标签或上级时，一个节点可能有多个分支 |
| Item | 审批节点分支，当节点为标签或上级时，一个节点可能有多个分支 |
| ItemName | 分支审批人姓名|
| ItemUserid | 分支审批人userid|
| ItemParty | 分支审批人所在部门|
| ItemImage | 分支审批人头像 |
| ItemStatus | 分支审批审批操作状态：1-审批中；2-已同意；3-已驳回；4-已转审 |
| ItemSpeech | 分支审批人审批意见 |
| ItemOpTime | 分支审批人操作时间 |
| NotifyNodes | 抄送信息，可能有多个抄送人 |
| NotifyNode | 抄送人信息 |
| ItemName | 抄送人姓名|
| ItemUserid | 抄送人userid|
| ItemParty | 抄送人所在部门|
| ItemImage | 抄送人头像 |
| approverstep | 当前审批节点：0-第一个审批节点；1-第二个审批节点…以此类推 |
