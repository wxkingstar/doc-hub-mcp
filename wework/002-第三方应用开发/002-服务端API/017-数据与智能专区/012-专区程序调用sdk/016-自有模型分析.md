---
title: "自有模型分析"
doc_id: 53352
category_id: 99835
source_url: https://developer.work.weixin.qq.com/document/path/53352
---
[TOC]

应用在专区中的程序可调用本接口传入会话内容，使用自己上传的大语言模型进行会话分析。

**详细说明**
> 该接口仅支持分析**文本、语音、音频存档消息**
> 对于上传的大语言模型，需要在5秒内完成http请求的回包（回包的内容将会被忽略，但仍需要用sdk进行回包构造），之后通过调用[上传异步任务结果](#53667)接口来返回分析的结果。

模型的输入协议由管理端的配置决定，除自定义文本外，还可以使用以下3项数据：
- 会话内容
识别并替换占位符 **{chat}**，将传入的msg_list对应的会话分行拼接，示例：
```
A说：今天天气真不错！
B说：确实呀！
```
识别并替换占位符 **{chatcontent}**，将传入的msg_list对应的会话内容填入（不包含发送者），示例：
```
今天天气真不错！
确实呀！
```
- 知识集文档片段
识别并替换占位符 **{knowledge}**，通过对比与会话内容的相似度来提取到topK个知识集文档片段，示例：
普通知识集文件：
```
文档1：文本片段1
文档2：文本片段2
```
「问答对」知识集文件：
```
文档1：问题1：答案1
文档2：问题2：答案2
```
- 客户标签
识别并替换占位符 **{tagjson}**，通过将客户标签组内的标签展开并表示为 json，可以在输入协议中引导模型理解该 json，示例：
```
{
  "tag_group": [{
    "group_id": "GROUPID1",
    "group_name": "客户年龄",
    "tag_list": [{
      "tag_id": "TAGID1",
      "tag_name": "30岁以下"
    },{
      "tag_id": "TAGID2",
      "tag_name": "30岁以上"
    }]
  }]
}
```

以下提供一个输入协议与输出协议示例，以供参考。
输入协议：
>{"prompt": "你是文档问答助手，能够利用给定的文档回答问题。给定的文档为：{knowledge}。请根据上述给定的文档，仔细思考，回答问题：{chatcontent}，回答时只能使用给定文档中直接相关的文本内容。忽略无关文本。回答要准确。兜底回复：很抱歉，根据现有的文档内容，无法回答这一问题。", "max_output_length": 200}

输出协议：
>{"result": "公司每周一、二、三分别有羽毛球、篮球、足球等运动。", "input_token": 83, "total_token": 199}

**权限说明**
| 应用类型 | 权限要求 |
| -------- | ---- | 
|自建应用|需具备「!!#ff0000 数据与智能专区权限!!」 |
|代开发应用|需具备「!!#ff0000 数据与智能专区权限!!」|
|第三方应用|需具备「!!#ff0000 数据与智能专区权限!!」|

## 创建自定义模型任务

**请求方法**
通过SDK调用，具体方式参考[专区程序使用指引](#54006)。

**请求接口名：**
create_model_task

**请求包体：**

```
{
  "model_id": "MODEL_ID",
  "ability_id": "ABILITY_ID",
  "tag_group_list": [{
    "group_id": "GROUP_ID1"
  },{
    "group_id": "GROUP_ID2"
  }],
  "kb_id": "KBID",
  "service_kb_id":"3RD_KB_ID",
 "msg_list":[{
 "msgid": "MSGID1",
 "encrypt_info":{
 "secret_key": "SECRETKEY1"
 }
 },{
 "msgid": "MSGID2",
 "encrypt_info":{
 "secret_key": "SECRETKEY2"
 }
 }],
  "debug_info":{
    "chat":"xxx",
    "chat_content":"xxx",
    "knowledge":"xxx",
    "tagjson":"xxx"
  },
  "escape_type":0
}
```

**参数说明：** 

| 参数 | 是否必须 | 说明 |
| ------- | ---- | ---- |
|model_id|是|模型id|
|ability_id|是|模型能力id|
|kb_id|否|[知识集id](#53353)。若同时传kb_id跟service_kb_id，则忽略service_kb_id|
|tag_group_list|否|客户标签组列表|
|tag_group_list.group_id|是|每个id代表一个[客户标签组](#17298)。|
|msg_list|是|消息列表，最多1000个|
|msg_list.msgid|是|每条消息对应的msgid。多次出现同一个msgid，以首次出现的为准。目前支持文本、语音、音频存档消息|
|msg_list.encrypt_info.secret_key|是|该消息的密钥，将encrypted_secret_key用RSA私钥解密后得到|
|debug_info|否|仅当处于调试模式时生效，将使用此字段下的内容而不是实际的知识集/标签组/消息来替换对应的占位符。在调试模式下，即使未填写，其他参数字段（kb_id、tag_group_list、msg_list）中填写的内容也将被忽略。<br>**请注意，在调试模式下，msg_list内填写的内容将被忽略，但为了保证流程的一致性，此时msg_list字段仍然是必填字段。**|
|debug_info.chat|是|将用于替换{chat}占位符|
|debug_info.chat_content|是|将用于替换{chatcontent}占位符|
|debug_info.knowledge|否|将用于替换{knowledge}占位符|
|debug_info.tagjson|否|将用于替换{tagjson}占位符<br>**建议将类似正式调用时替换结果的json结构转义后作为字符串传入，以获得与正式调用时更一致的调试体验**|
|escape_type|否|传入自有模型的内容的转义方式<br>会被转义的字符包括`"`、`\ `、`/`、`\b`、`\f`、`\n`、`\r`、`\t`<br>该字段为0时，这些字符将被转义成空格；<br>该字段为1时，这些字符将分别被转义成`\"`、`\\ `、`\/`、`\\b`、`\\f`、`\\n`、`\\r`、`\\t`<br>默认为0|

**返回结果：**
```
{
 "errcode": 0,
 "errmsg": "ok",
 "jobid": "JOBID",
 "fail_list":[
 {
 "errcode": 710601,
 "errmsg": "xxx",
 "msgid": "MSGID2",
 "encrypt_info":{
 "secret_key": "SECRETKEY2"
 }
 }
 ]
}
```
**参数说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|
|jobid|任务id。首次提交时返回|
|fail_tag_group_id_list|非法的客户标签组id列表|
|fail_list|提交出错的消息列表，只有msgid重复项返回至该列表，详见**FailMsg说明**|

**FailMsg说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|
|msgid|每条消息对应的msgid，与入参对应|
|encrypt_info|每条消息对应的加密信息，与入参对应|
|encrypt_info.secret_key|加密消息用的secret_key|

## 获取自定义模型结果

**请求方法**
通过SDK调用，具体方式参考[专区程序使用指引](#54006)。

**请求接口名：**
get_model_task_result

**请求包体：**

```
{
 "jobid": "JOBID"
}
```

**参数说明：** 

| 参数 | 是否必须 | 说明 |
| ------- | ---- | ---- |
|jobid| 是 |任务id|

**返回结果：**
```
{
 "errcode": 0,
 "errmsg": "ok",
 "fail_list":[{
 "errcode": 710601,
 "errmsg": "xxx",
 "msgid": "MSGID"
 }],
  "response_errcode": 0,
  "response_data": "xxx"
}
```
**参数说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|
|fail_list| 错误的消息列表，如msgid不存在、非文本等，详见“创建自定义模型任务”的**FailMsg说明**|
|response_errcode |自有模型上报的错误码 |
|response_data| 自有模型上报的结果，必须符合模型能力对应的输出协议 |

## 频率限制说明
- 每企业每天不超过1万次（按调用次数限制）
