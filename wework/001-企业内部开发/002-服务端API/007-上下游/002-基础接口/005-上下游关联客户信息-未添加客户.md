---
title: "上下游关联客户信息-未添加客户"
doc_id: 43378
category_id: 97357
source_url: https://developer.work.weixin.qq.com/document/path/43378
---
[TOC]
## 场景
品牌在公众号、小程序上的微信粉丝，可以跟经销商用企微添加的微信客户打通数据
实现效果：共享客户信息，完善客户画像，促进成交

## 准备工作
1. 品牌有自己主体（或isv主体）的公众号、小程序
2. 品牌创建上下游，经销商新建企业并加入上下游
3. 品牌共享应用给经销商
4. 经销商管理员授权应用获取「企业客户」权限

## 思路
**针对经销商已用企微添加的微信客户（[接口链接](https://developer.work.weixin.qq.com/document/path/95818)）**
品牌通过以下接口把公众号、小程序粉丝的 unionid （从微信开放平台获取）转换成 external_userid

**针对经销商还未用企微添加的微信客户（当前接口）**
1. 品牌提前把公众号、小程序粉丝的 unionid （从微信开放平台获取）转换成 pending_id
2. 经销商用企微添加微信客户时，用 external_userid 查询 pending_id
3. unionid 和 external_userid 数据打通

---

**pending_id的说明**
- pending_id主要用于关联微信unionid与外部联系人external_userid，可理解为临时外部联系人ID；
- 上游企业可通过此接口将微信unionid转为pending_id，当微信用户成为下游企业客户后，可使用上下游external_userid转pending_id接口将下游external_userid转换为pending_id，建立unionid => pending_id => external_userid的映射关系；
- pending_id有效期90天，共享应用内唯一。

## unionid查询pending_id

该接口有调用频率限制，按上游企业维度，限制为：10万次/小时、48万次/天、750万次/月。

**请求方式：**POST（**HTTPS**）
**请求地址**：https://qyapi.weixin.qq.com/cgi-bin/corpgroup/unionid_to_pending_id?access_token=ACCESS_TOKEN

**请求参数：**
```
{
 "unionid":"UNIONID",
 "openid":"OPENID"
}
```

**参数说明：**

| 参数 | 必须 | 说明 |
| :----------- | :--- | :----------------- |
| access_token | 是 | 上游企业自建应用或代开发应用的access_token |
| unionid |是|微信客户的unionid|
| openid | 是 |微信客户的openid|

**权限说明：**
> 1. 调用该接口的应用必须是上下游共享的自建应用或代开发应用
> 2. 应用需要具有客户联系权限
> 3. 当前授权企业必须已认证或已验证；若为代开发应用，服务商必须已认证
> 4. unionid（即微信开放平台账号主体）与openid（即小程序或服务号账号主体）需要认证，且主体名称需与上游企业的主体名称一致（[查看由服务商代注册的开放平台账号认证流程](https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/product/Open_Platform_Account_Management.html#%E5%9B%9B%E3%80%81%E8%AE%A4%E8%AF%81%E4%BB%A3%E6%B3%A8%E5%86%8C%E7%9A%84%E5%B8%90%E5%8F%B7)）
> 5. openid与unionid必须是在同一个小程序获取到的
> 6. pending_id有效期90天

**返回结果：**

```
{
 "errcode":0,
 "errmsg":"ok",
 "pending_id":"PENDINGID"
}
```
**参数说明：**

| 参数 | 说明 |
| :----------- | :----------------- |
| errcode | 返回码 |
| errmsg | 对返回码的文本描述内容 |
| pending_id | unionid和openid对应的pending_id |

## external_userid查询pending_id

**请求方式：**POST（**HTTPS**）
**请求地址**：https://qyapi.weixin.qq.com/cgi-bin/corpgroup/batch/external_userid_to_pending_id?access_token=ACCESS_TOKEN

**请求参数：**
```
{
 "chat_id":"xxxxxx",
 "external_userid":["oAAAAAAA", "oBBBBB"]
}
```

**参数说明：**

| 参数 | 必须 | 说明 |
| :----------- | :--- | :----------------- |
| access_token | 是 | 上下游企业共享的自建应用或代开发应用的access_token |
| external_userid | 是 | 上游或下游企业外部联系人id，最多同时查询100个 |
| chat_id | 否 | 群id，如果有传入该参数，则只检查群主是否在可见范围，同时会忽略在该群以外的external_userid。如果不传入该参数，则只检查客户跟进人是否在可见范围内。|

**权限说明：**
> 调用该接口的应用必须是上下游共享的自建应用或代开发应用
> 应用需要具有客户联系权限
> 该客户的跟进人或其所在客户群群主必须在应用的可见范围之内
> 上游应用须调用过[unionid转pending_id接口](#unionid转换pending_id)
> 上游和下游企业须认证或验证；若为代开发应用，服务商必须已认证

**返回结果：**

```
{
 "errcode":0,
 "errmsg":"ok",
  "result":[
     {
      "external_userid":"oAAAAAAA",
      "pending_id":"pAAAAA"
     },
     {
      "external_userid":"oBBBBB",
      "pending_id":"pBBBBB"
     }
   ]
}
```
**参数说明：**

| 参数 | 说明 |
| :----------- | :----------------- |
| errcode | 返回码 |
| errmsg | 对返回码的文本描述内容 |
| result | 转换结果 |
| result.external_userid | 转换的external_userid |
| result.pending_id | 该微信账号还未成为企业客户时，返回的临时外部联系人ID |
