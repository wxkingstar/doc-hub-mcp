---
title: "获取会话记录"
doc_id: 42660
category_id: 99670
source_url: https://developer.work.weixin.qq.com/document/path/99670
---
最后更新：2024/07/16

通过接口，获取企业一段时间内的会话记录。
::: warning 调用该接口前必须先[设置公钥](#51799)
:::

**权限说明：**
> 1.消息发送者或者接收者必须在会话存档接口权限授权范围以及“会话内容存档”配置的“企业版”或者“服务版”中（金融行业为“基础版”跟“企业版”）
> 2. 只可获取5天内的企业客户会话记录数据
> 3. 一次拉取调用上限1000条会话记录，可以通过分页拉取的方式来依次拉取

| 应用类型 | 权限要求 |
| -------- | ---- | 
|自建应用|暂不支持 |
|代开发应用|暂不支持|
|第三方应用|暂不支持|
|会话存档接口授权|需具备「!!#ff0000 会话存档接口权限- 获取会话记录!!」权限|

**请求方式：** POST（**HTTPS**）
**请求地址：** https://qyapi.weixin.qq.com/cgi-bin/chatdata/sync_msg?access_token=ACCESS_TOKEN

**请求包体：**

```
{
  "cursor":"RMTJID",
  "token":"NGEJKGOEGJKOEGNEOAGOEGOKEGHOEEEEE",
  "limit":200
}
```

**参数说明：** 

| 参数 | 是否必须 | 说明 |
| ------- | ---- | ---- |
|access_token|是|调用接口凭证|
|cursor|否|上一次调用时返回的next_cursor，第一次拉取可以不填。若不填，从3天内最早的消息开始返回。不多于128字节|
|token|否|回调事件返回的 `token` 字段，10分钟内有效；建议都从回调事件中取出token填上，否则接口会有严格的频率限制。不多于128字节|
|limit| 否| 拉取数量，默认值200，最大值1000|

**返回结果：**
```
{
 "errcode":0,
 "errmsg":"ok",
 "has_more":true,
 "next_cursor":"JGNLGEHJGIE",
 "msg_list":[
 {
 "msgid":"xxxmsgid",
 "sender":{
 "type":1,
 "id":"woxxxxxmmgjiegjie"
 },
      "receiver_list": [
        {
          "type": 1,
          "id": "woAAAAAAAAAAA"
        },
        {
          "type": 2,
          "id": "wmXXXXXXXXXXXXX"
        }
      ],
      "chatid": "wrXXXXXXXXXX",
 "send_time":166666666,
 "msgtype":2,
 "service_encrypt_info":{
 "encrypted_secret_key":"KEYAAAAAAABBBBBB",
 "public_key_ver":1
 }
 }
 ]
}
```
**参数说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|
|has_more|是否还有更多数据。0-否；1-是。|
|next_cursor|下次调用带上该值，则从当前的位置继续往后拉，以实现增量拉取。强烈建议对该字段入库保存，每次请求读取带上，请求结束后更新。避免因意外丢，导致必须从头开始拉取，引起消息延迟。|
|msg_list|消息列表，按消息发送时间升序排序|
|msgid|每条消息对应的msgid|
|sender.type|消息发送者身份类型。1：员工；2：外部联系人; 3：机器人|
|sender.id|消息发送者的id，当消息发送者为员工时，该字段为员工的open_userid；当消息发送者的身份为外部联系人时，该字段为外部联系人的id|
|chatid|群ID，当消息是群消息的时候会返回该字段|
|receiver_list.type|消息接受者的身份类型。1：员工；2：外部联系人; 3：机器人|
|receiver_list.id|当接收者身份类型为员工时，该字段为员工open_userid；当接收者身份类型为外部联系人时，该字段为外部联系人id；当接收者身份类型为机器人式为机器人ID|
|send_time|消息发送时间对应的unix时间戳|
|msgtype|消息类型。枚举值定义见下方[消息类型](#消息类型)|
|service_encrypt_info.encrypted_secret_key|加密后的密钥，使用[设置公钥](#51799)设置的公钥进行加密，需要服务商用私钥解密后才可传入[会话展示组件](#50920)|
|service_encrypt_info.public_key_ver|公钥版本号|

**消息类型**
| 类型| 说明|
|-----|-----|
|0|暂不支持的消息类型|
|1|文本|
|2|图片|
|3|表情|
|4|链接|
|5|小程序|
|6|语音|
|7|视频|
|8|文件|
|9|名片|
|10|转发消息|
|11|视频号|
|12|日程|
|13|红包|
|14|地理位置|
|15|快速会议|
|16|待办|
|17|投票|
|18|在线文档|
|19|图文消息|
|20|图文混合消息|
|21|音频存档|
|22|音视频通话|
|23|微盘文件|
|24|同意会话存档|
|25|拒绝会话存档|
|26|群接龙|
|27|markdown|

<br>
::: tip 提示
音视频通话分为微信互通通话和普通通话两种类型。
微信互通：1次音视频通话只会产生1条记录。
普通通话：1次音视频通话会产生多条记录，由参与人数决定。
:::
