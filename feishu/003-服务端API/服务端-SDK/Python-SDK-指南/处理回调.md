---
title: "å¤„ç†å›è°ƒ"
source_url: https://open.feishu.cn/document/server-side-sdk/python--sdk/handle-callbacks
last_remote_update: 2025-03-28
last_remote_update_timestamp: 1743151786000
---
æœ€åæ›´æ–°äº 2025-03-28

# å¤„ç†å›è°ƒ

é€šè¿‡å›è°ƒè®¢é˜…åŠŸèƒ½ï¼Œåº”ç”¨å¯ä»¥åŠæ—¶æ¥æ”¶å¹¶å¤„ç†é£ä¹¦ä¸­ç‰¹å®šçš„äº¤äº’è¡Œä¸ºï¼ˆä¾‹å¦‚ï¼Œé£ä¹¦å¡ç‰‡äº¤äº’ã€é“¾æ¥é¢„è§ˆç­‰ï¼‰ï¼Œå¹¶æ ¹æ®äº¤äº’ç»“æœåšå¯¹åº”çš„ä¸šåŠ¡å¤„ç†ï¼Œè¯¦æƒ…å‚è§[å›è°ƒæ¦‚è¿°](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/event-subscription-guide/callback-subscription/callback-overview)ã€‚åœ¨åº”ç”¨å†…è®¢é˜…å›è°ƒæ—¶ï¼Œè¿˜éœ€è¦åœ¨æœ¬åœ°æœåŠ¡ç«¯å»ºç«‹ä¸åº”ç”¨çš„è¿æ¥ï¼Œä»¥ä¾¿æ¥æ”¶å›è°ƒæ•°æ®ã€‚æœåŠ¡ç«¯ SDK å°è£…äº†é•¿è¿æ¥æ–¹å¼ï¼Œå¯ä»¥å¿«é€Ÿå»ºç«‹æ•°æ®é€šé“å¤„ç†å›è°ƒï¼›ä½ ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå»º HTTP æœåŠ¡å™¨å¤„ç†å›è°ƒã€‚ä¸¤ç§æ–¹å¼ä»‹ç»å¦‚ä¸‹ï¼š

è®¢é˜…æ–¹å¼ | ä»‹ç»
--- | ---
ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶å›è°ƒ | è¯¥æ–¹å¼æ˜¯é£ä¹¦ SDK å†…æä¾›çš„èƒ½åŠ›ï¼Œä½ å¯ä»¥é€šè¿‡é›†æˆé£ä¹¦ SDK ä¸å¼€æ”¾å¹³å°å»ºç«‹ä¸€æ¡ WebSocket å…¨åŒå·¥é€šé“ï¼ˆä½ çš„æœåŠ¡å™¨éœ€è¦èƒ½å¤Ÿè®¿é—®å…¬ç½‘ï¼‰ã€‚åç»­å½“åº”ç”¨è®¢é˜…çš„å›è°ƒå‘ç”Ÿæ—¶ï¼Œå¼€æ”¾å¹³å°ä¼šé€šè¿‡è¯¥é€šé“å‘ä½ çš„æœåŠ¡å™¨å‘é€æ¶ˆæ¯ã€‚ç›¸è¾ƒäºä¼ ç»Ÿçš„ Webhook æ¨¡å¼ï¼Œé•¿è¿æ¥æ¨¡å¼å¤§å¤§é™ä½äº†æ¥å…¥æˆæœ¬ï¼Œå°†åŸå…ˆ 1 å‘¨å·¦å³çš„å¼€å‘å‘¨æœŸé™ä½åˆ° 5 åˆ†é’Ÿã€‚å…·ä½“ä¼˜åŠ¿å¦‚ä¸‹ï¼šæµ‹è¯•é˜¶æ®µæ— éœ€ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·ï¼Œé€šè¿‡é•¿è¿æ¥æ¨¡å¼åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å³å¯æ¥æ”¶å›è°ƒã€‚SDK å†…å°è£…äº†é‰´æƒé€»è¾‘ï¼Œåªåœ¨å»ºè¿æ—¶è¿›è¡Œé‰´æƒï¼Œåç»­å›è°ƒæ¨é€å‡ä¸ºæ˜æ–‡æ•°æ®ï¼Œæ— éœ€å†å¤„ç†è§£å¯†å’ŒéªŒç­¾é€»è¾‘ã€‚åªéœ€ä¿è¯è¿è¡Œç¯å¢ƒå…·å¤‡è®¿é—®å…¬ç½‘èƒ½åŠ›å³å¯ï¼Œæ— éœ€æä¾›å…¬ç½‘ IP æˆ–åŸŸåã€‚æ— éœ€éƒ¨ç½²é˜²ç«å¢™å’Œé…ç½®ç™½åå•ã€‚
å°†å›è°ƒå‘é€è‡³å¼€å‘è€…æœåŠ¡å™¨ | ä¼ ç»Ÿçš„ Webhook æ¨¡å¼ï¼Œè¯¥æ–¹å¼éœ€è¦ä½ æä¾›ç”¨äºæ¥æ”¶å›è°ƒæ¶ˆæ¯çš„æœåŠ¡å™¨å…¬ç½‘åœ°å€ã€‚åç»­å½“åº”ç”¨è®¢é˜…çš„å›è°ƒå‘ç”Ÿæ—¶ï¼Œå¼€æ”¾å¹³å°ä¼šå‘æœåŠ¡å™¨çš„å…¬ç½‘åœ°å€å‘é€ HTTP POST è¯·æ±‚ï¼Œè¯·æ±‚å†…åŒ…å«å›è°ƒæ•°æ®ã€‚

## æ³¨æ„äº‹é¡¹

å¼€æ”¾å¹³å° SDK ä»…æ”¯æŒå¯¹è±¡ç±»å‹çš„å¡ç‰‡å›ä¼ å‚æ•°ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²ç±»å‹ã€‚

![](https://sf3-cn.feishucdn.com/obj/open-platform-opendoc/6d6c7cde74877dabc032336ceb1bd85d_aQIuKttvTP.png?height=755&lazyload=true&maxWidth=600&width=1542)

```json
{
  "behaviors": [
    { // å£°æ˜äº¤äº’ç±»å‹æ˜¯å¡ç‰‡å›ä¼ äº¤äº’ã€‚
      "type": "callback",
      "value": {
        // å›ä¼ äº¤äº’æ•°æ®ã€‚å¼€æ”¾å¹³å° SDK ä»…æ”¯æŒå¯¹è±¡ç±»å‹çš„å¡ç‰‡å›ä¼ å‚æ•°ã€‚
        "key": "value"
      }
    }
  ]
}
```

## ï¼ˆæ¨èï¼‰æ–¹å¼ä¸€ï¼šä½¿ç”¨é•¿è¿æ¥æ¥æ”¶å›è°ƒ

å¦‚æœå›è°ƒè®¢é˜…æ–¹å¼éœ€è¦é€‰æ‹© **ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶å›è°ƒ**ï¼Œåˆ™éœ€è¦å…ˆä½¿ç”¨ SDK å»ºç«‹ä¸åº”ç”¨çš„è¿æ¥ã€‚æœ¬ç« èŠ‚æä¾›å»ºç«‹é•¿è¿æ¥çš„ç¤ºä¾‹ä»£ç ä¸ä»£ç è§£æï¼Œé€šè¿‡ SDK å»ºç«‹é•¿è¿æ¥ä¹‹åï¼Œä½ æ‰èƒ½åœ¨åº”ç”¨çš„å›è°ƒè®¢é˜…æ–¹å¼ä¸­ä¿å­˜ **ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶å›è°ƒ** æ–¹å¼ã€‚å…³äºåº”ç”¨å†…é…ç½®å›è°ƒè®¢é˜…æ–¹å¼çš„ä»‹ç»ï¼Œå‚è€ƒ[é…ç½®å›è°ƒè®¢é˜…æ–¹å¼](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/event-subscription-guide/callback-subscription/configure-callback-request-address)ã€‚

### ä½¿ç”¨é™åˆ¶

- é•¿è¿æ¥æ¨¡å¼ä»…æ”¯æŒä¼ä¸šè‡ªå»ºåº”ç”¨ã€‚
- [æ¶ˆæ¯å¡ç‰‡å›ä¼ äº¤äº’ï¼ˆæ—§ï¼‰](https://open.feishu.cn/document/ukTMukTMukTM/uYzM3QjL2MzN04iNzcDN/configuring-card-callbacks/card-callback-structure)å›è°ƒä¸æ”¯æŒ **ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶å›è°ƒ** è®¢é˜…æ–¹å¼ï¼Œåªèƒ½é€‰æ‹© **å°†å›è°ƒå‘é€è‡³å¼€å‘è€…æœåŠ¡å™¨** è®¢é˜…æ–¹å¼ã€‚
- æ¯ä¸ªåº”ç”¨æœ€å¤šå»ºç«‹ 50 ä¸ªè¿æ¥ï¼ˆåœ¨é…ç½®é•¿è¿æ¥æ—¶ï¼Œæ¯åˆå§‹åŒ–ä¸€ä¸ª client å°±æ˜¯ä¸€ä¸ªè¿æ¥ï¼‰ã€‚

### æ³¨æ„äº‹é¡¹

- ä¸ **å°†å›è°ƒå‘é€è‡³å¼€å‘è€…æœåŠ¡å™¨** æ–¹å¼çš„è¦æ±‚ç›¸åŒï¼Œé•¿è¿æ¥æ¨¡å¼ä¸‹æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦åœ¨ 3 ç§’å†…å¤„ç†å®Œæˆã€‚
- é•¿è¿æ¥æ¨¡å¼çš„æ¶ˆæ¯æ¨é€ä¸º **é›†ç¾¤æ¨¡å¼**ï¼Œä¸æ”¯æŒå¹¿æ’­ï¼Œå³å¦‚æœåŒä¸€åº”ç”¨éƒ¨ç½²äº†å¤šä¸ªå®¢æˆ·ç«¯ï¼ˆclientï¼‰ï¼Œé‚£ä¹ˆåªæœ‰å…¶ä¸­éšæœºä¸€ä¸ªå®¢æˆ·ç«¯ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚

### é•¿è¿æ¥ä»£ç 

åŒ…å«[å¡ç‰‡å›ä¼ äº¤äº’](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/card-callback-communication)ã€[æ‹‰å–é“¾æ¥é¢„è§ˆæ•°æ®](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/development-link-preview/pull-link-preview-data-callback-structure) å›è°ƒã€‚

```python
import lark_oapi as lark
from lark_oapi.event.callback.model.p2_card_action_trigger import P2CardActionTrigger, P2CardActionTriggerResponse
from lark_oapi.event.callback.model.p2_url_preview_get import P2URLPreviewGet, P2URLPreviewGetResponse

# ç›‘å¬ã€Œå¡ç‰‡å›ä¼ äº¤äº’ card.action.triggerã€äº‹ä»¶ P2CardActionTriggerã€‚
def do_card_action_trigger(data: P2CardActionTrigger) -> P2CardActionTriggerResponse:
    print(lark.JSON.marshal(data))
    resp = {
        "toast": {
            "type": "info",
            "content": "å¡ç‰‡å›ä¼ æˆåŠŸ from python sdk"
        }
    }
    return P2CardActionTriggerResponse(resp)

# ç›‘å¬ã€Œæ‹‰å–é“¾æ¥é¢„è§ˆæ•°æ® url.preview.getã€äº‹ä»¶ P2URLPreviewGetã€‚
def do_url_preview_get(data: P2URLPreviewGet) -> P2URLPreviewGetResponse:
    print(lark.JSON.marshal(data))
    resp = {
        "inline": {
            "title": "é“¾æ¥é¢„è§ˆæµ‹è¯•",
        }
    }
    return P2URLPreviewGetResponse(resp)
event_handler = lark.EventDispatcherHandler.builder("", "") \
    # æ³¨å†Œå›è°ƒå¤„ç†å‡½æ•°ï¼Œå›ºå®šä»¥ register_p2 ä¸ºå‰ç¼€ã€‚
    .register_p2_card_action_trigger(do_card_action_trigger) \
    .register_p2_url_preview_get(do_url_preview_get) \
    .build()
def main():
    cli = lark.ws.Client(lark.APP_ID, lark.APP_SECRET,
                         event_handler=event_handler, log_level=lark.LogLevel.DEBUG)
    cli.start()
if __name__ == "__main__":
    main()
```
ä»£ç å®ç°æ­¥éª¤ï¼š

1. é€šè¿‡ lark.EventDispatcherHandler.builder() åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨ï¼ˆevent_handlerï¼‰ï¼Œè¯¥æ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°å¿…é¡»å¡«ç©ºå­—ç¬¦ä¸²ã€‚

2. é€šè¿‡ event_handler çš„ register_xxxx() æ–¹æ³•ç›‘å¬ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œä¸Šè¿°ç¤ºä¾‹ä¸­ç›‘å¬äº†[å¡ç‰‡å›ä¼ äº¤äº’ card.action.trigger](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/card-callback-communication) å’Œ[æ‹‰å–é“¾æ¥é¢„è§ˆæ•°æ® url.preview.get](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/development-link-preview/pull-link-preview-data-callback-structure) ä¸¤ä¸ªå›è°ƒã€‚

3. é€šè¿‡ register_p2_card_action_trigger æ³¨å†Œå¡ç‰‡å›è°ƒçš„å¤„ç†å‡½æ•°ã€‚

4. é€šè¿‡ register_p2_url_preview_get æ³¨å†Œé“¾æ¥é¢„è§ˆå›è°ƒçš„å¤„ç†å‡½æ•°ã€‚

5. é€šè¿‡ lark.ws.Client() åˆå§‹åŒ–é•¿è¿æ¥å®¢æˆ·ç«¯ï¼Œå¿…å¡«å‚æ•°ä¸ºåº”ç”¨çš„ APP_ID å’Œ APP_SECRETï¼Œéœ€ç™»å½•[å¼€å‘è€…åå°](https://open.feishu.cn/app)ï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µçš„ **å‡­è¯ä¸åŸºç¡€ä¿¡æ¯** > **åº”ç”¨å‡­è¯** åŒºåŸŸè·å–ã€‚

![](https://sf3-cn.feishucdn.com/obj/open-platform-opendoc/f7f89950be7e57c2760a8b5b1f5e17c9_Rnb3oFejzG.png?height=524&lazyload=true&maxWidth=600&width=3594)

6. å¯é€‰å‚æ•°ä¼ å…¥ event_handlerï¼ŒåŒæ—¶å¯è®¾ç½®æ—¥å¿—çº§åˆ«ã€‚

7. é€šè¿‡ cli.start() å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå¦‚è¿æ¥æˆåŠŸï¼Œæ§åˆ¶å°ä¼šæ‰“å° `connected to wss://xxxxx`ï¼Œä¸»çº¿ç¨‹å°†é˜»å¡ï¼Œç›´åˆ°è¿›ç¨‹ç»“æŸã€‚

![](https://sf3-cn.feishucdn.com/obj/open-platform-opendoc/ac590caeb5cc3fe42ca3855696f42c6e_BI8PJEBHGZ.png?height=264&lazyload=true&maxWidth=600&width=2488)

## æ–¹å¼äºŒï¼šå°†å›è°ƒå‘é€è‡³å¼€å‘è€…æœåŠ¡å™¨

å¦‚æœå›è°ƒè®¢é˜…æ–¹å¼é€‰æ‹© **å°†å›è°ƒå‘é€è‡³å¼€å‘è€…æœåŠ¡å™¨**ï¼Œåˆ™éœ€è¦è®¾ç½®å›è°ƒè¯·æ±‚ç½‘å€ï¼Œå¹¶è®¢é˜…å›è°ƒã€‚ä¾‹å¦‚ï¼Œä½ é…ç½®äº†å¯äº¤äº’çš„é£ä¹¦å¡ç‰‡ï¼ˆåŸæ¶ˆæ¯å¡ç‰‡ï¼‰ï¼Œå½“ç”¨æˆ·åœ¨å¡ç‰‡å†…è¿›è¡Œäº¤äº’åï¼Œé£ä¹¦æœåŠ¡å™¨ä¼šå‘è¯·æ±‚ç½‘å€å›è°ƒåŒ…å« JSON æ•°æ®çš„ HTTP POST è¯·æ±‚ã€‚å› æ­¤ï¼Œä½ éœ€è¦åœ¨é¡¹ç›®ä¸­å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡ï¼Œç„¶åæŠŠ HTTP æœåŠ¡çš„ URL ç»‘å®šåˆ°åº”ç”¨çš„å›è°ƒè¯·æ±‚ç½‘å€ä¸­ï¼Œä»¥æ¥æ”¶å›è°ƒæ•°æ®ã€‚æœ¬ç« èŠ‚æä¾›äº†ä½¿ç”¨ flask å¯åŠ¨ httpServer çš„ç¤ºä¾‹ä»£ç ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯å…¶ä»– HTTP æ¡†æ¶ï¼Œåªéœ€å¤„ç† HTTP å‡ºå…¥å‚è½¬æ¢å³å¯ã€‚

å¤„ç†å›è°ƒçš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ŒåŒ…å«[å¡ç‰‡å›ä¼ äº¤äº’](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/card-callback-communication)ã€[æ‹‰å–é“¾æ¥é¢„è§ˆæ•°æ®](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/development-link-preview/pull-link-preview-data-callback-structure)å›è°ƒã€‚

```python
from flask import Flask

import lark_oapi as lark
from event.callback.model.p2_card_action_trigger import P2CardActionTrigger, P2CardActionTriggerResponse
from event.callback.model.p2_url_preview_get import P2URLPreviewGet, P2URLPreviewGetResponse
from lark_oapi.adapter.flask import *
from lark_oapi.api.im.v1 import *

app = Flask(__name__)

# è‡ªå®šä¹‰è®¢é˜…çš„äº‹ä»¶æˆ–è€…å›è°ƒ
def do_customized_event(data: lark.CustomizedEvent) -> None:
    print(lark.JSON.marshal(data))

# æ–°ç‰ˆå¡ç‰‡å›è°ƒï¼Œå¡ç‰‡å›ä¼ äº¤äº’ card.action.trigger
def do_card_action_trigger(data: P2CardActionTrigger) -> P2CardActionTriggerResponse:
    print(lark.JSON.marshal(data))
    resp = {
        "toast": {
            "type": "info",
            "content": "å¡ç‰‡å›ä¼ æˆåŠŸ from python sdk"
        }
    }
    return P2CardActionTriggerResponse(resp)

# æ‹‰å–é“¾æ¥é¢„è§ˆæ•°æ® url.preview.get
def do_url_preview_get(data: P2URLPreviewGet) -> P2URLPreviewGetResponse:
    print(lark.JSON.marshal(data))
    resp = {
        "inline": {
            "title": "é“¾æ¥é¢„è§ˆæµ‹è¯•",
        }
    }
    return P2URLPreviewGetResponse(resp)

handler = lark.EventDispatcherHandler.builder(lark.ENCRYPT_KEY, lark.VERIFICATION_TOKEN, lark.LogLevel.DEBUG) \
    .register_p2_card_action_trigger(do_card_action_trigger) \
    .register_p2_url_preview_get(do_url_preview_get) \
    .register_p1_customized_event("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„ event çš„ keyï¼Œä¾‹å¦‚ out_approval", do_customized_event) \
    .build()

@app.route("/event", methods=["POST"])
def event():
    resp = handler.do(parse_req())
    return parse_resp(resp)

if __name__ == "__main__":
    app.run(port=7777)
```

å¤„ç†[æ¶ˆæ¯å¡ç‰‡å›ä¼ äº¤äº’ï¼ˆæ—§ï¼‰](https://open.feishu.cn/document/ukTMukTMukTM/uYzM3QjL2MzN04iNzcDN/configuring-card-callbacks/card-callback-structure)å›è°ƒçš„å†™æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œç¤ºä¾‹ä¸­ä½¿ç”¨ flask å¯åŠ¨ httpServerï¼Œå¦‚ä½¿ç”¨å…¶ä»– web æ¡†æ¶ï¼Œåªéœ€å¤„ç† http å‡ºå…¥å‚è½¬æ¢å³å¯ã€‚

```python
from typing import Any
from flask import Flask
import lark_oapi as lark
from lark_oapi.adapter.flask import *

app = Flask(__name__)

def do_interactive_card(data: lark.Card) -> Any:
    print(lark.JSON.marshal(data))
    content = {
        "header": {
            "title": {
                "tag": "plain_text",
                "content": "æ›´æ–°å¡ç‰‡æˆåŠŸ"
            },
            "template": "green"
        },
        "elements": [
            {
                "tag": "div",
                "text": {
                    "tag": "lark_md",
                    "content": "**Success!\næˆåŠŸå•¦ğŸ˜„**"
                }
            },
        ]
    }
    return content

handler = lark.CardActionHandler.builder(lark.ENCRYPT_KEY, lark.VERIFICATION_TOKEN, lark.LogLevel.DEBUG) \
    .register(do_interactive_card) \
    .build()

@app.route("/card", methods=["POST"])
def card():
    resp = handler.do(parse_req())
    return parse_resp(resp)

if __name__ == "__main__":
    app.run(port=7777)
```
