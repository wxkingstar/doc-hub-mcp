---
title: "会话内容分析"
doc_id: 50846
category_id: 99678
source_url: https://developer.work.weixin.qq.com/document/path/99678
---
最后更新：2024/03/28

[TOC]

服务商可调用本组接口进行会话内容分析。
分析任务分为“单条消息分析”和“批量分析”，共有3种分析任务：
（1）情感分析（单条消息分析）
（2）反垃圾分析（单条消息分析）
（3）摘要提取（批量分析）
“单条分析”任务对每条消息都会返回一个分析结果，“批量分析”任务当前任务只返回一个分析结果。

**详细说明**
> 该接口仅支持分析**文本消息**
> “摘要提取” 任务中文本文字总和最多支持1万字，超过的将忽略

| 应用类型 | 权限要求 |
| -------- | ---- | 
|自建应用|暂不支持 |
|代开发应用|暂不支持|
|第三方应用|暂不支持|
|会话存档接口授权|需具备「!!#ff0000 会话存档接口权限- 会话统计分析!!」权限|

## 创建分析任务
**请求方式：** POST（**HTTPS**）
**请求地址：** https://qyapi.weixin.qq.com/cgi-bin/chatdata/analyze_task_add?access_token=ACCESS_TOKEN

**请求包体：**

```
{
 "analyze_task": 1,
 "jobid": "JOBID",
 "msg_list":[
 {
 "msgid": "MSGID1",
 "encrypt_info":{
 "secret_key": "SECRETKEY1"
 }
 },
 {
 "msgid": "MSGID2",
 "encrypt_info":{
 "secret_key": "SECRETKEY2"
 }
 }
 ]
}
```

**参数说明：** 

| 参数 | 是否必须 | 说明 |
| ------- | ---- | ---- |
|access_token|是|调用接口凭证|
|analyze_task| 是 |指定要分析的任务<br>1: （单条分析）情感分析<br> 2: （单条分析）反垃圾分析<br> 3: （批量分析）摘要提取。展示结果为文本|
|jobid| 否 |任务id。首次提交时不填，后续提交时填入首次返回的jobid|
|msg_list|是|消息列表，每次最多1000个。总和不超过1000个。|
|msg_list.msgid|是|每条消息对应的msgid。多次出现同一个msgid，以首次出现的为准|
|msg_list.encrypt_info.secret_key|是|该消息的密钥，将encrypted_secret_key用RSA私钥解密后得到|

**返回结果：**
```
{
 "errcode": 0,
 "errmsg": "ok",
 "jobid": "JOBID",
 "fail_list":[
 {
 "errcode": 710601,
 "errmsg": "xxx",
 "msgid": "MSGID2",
 "encrypt_info":{
 "secret_key": "SECRETKEY2"
 }
 }
 ]
}
```
**参数说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|
|jobid|任务id。首次提交时返回|
|fail_list|提交出错的消息列表，只有msgid重复项返回至该列表|
|fail_list.errcode |错误码 |
|fail_list.errmsg|错误码说明|
|fail_list.msgid|每条消息对应的msgid，与入参对应|
|fail_list.msgid.encrypt_info|每条消息对应的加密信息，与入参对应|

## 提交分析任务
**请求方式：** POST（**HTTPS**）
**请求地址：** https://qyapi.weixin.qq.com/cgi-bin/chatdata/analyze_task_submit?access_token=ACCESS_TOKEN

**请求包体：**

```
{
 "jobid": "JOBID"
}
```

**参数说明：** 

| 参数 | 是否必须 | 说明 |
| ------- | ---- | ---- |
|jobid| 是 |任务id|

**返回结果：**
```
{
 "errcode": 0,
 "errmsg": "ok"
}
```
**参数说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|

## 获取任务结果
**请求方式：** POST（**HTTPS**）
**请求地址：** https://qyapi.weixin.qq.com/cgi-bin/chatdata/analyze_task_result?access_token=ACCESS_TOKEN

**请求包体：**

```
{
 "jobid": "JOBID"
}
```

**参数说明：** 

| 参数 | 是否必须 | 说明 |
| ------- | ---- | ---- |
|jobid| 是 |任务id|

**返回结果：**
```
{
 "errcode": 0,
 "errmsg": "ok",
 "status": 1,
 "analyze_result": {
 "result_id": "RESULTID1",
 "service_encrypt_info": {
 "encrypted_secret_key": "KEYAAAAAAABBBBBB",
 "public_key_ver": 1
 }
 },
 "analyze_result_list":[
 {
 "errcode": 0,
 "errmsg": "ok",
 "msgid": "MSGID1",
 "sentiment_result": 2,
 "spam_result": 1
 },
 {
 "errcode": 710601,
 "errmsg": "xxx",
 "msgid": "MSGID4"
 }
 ]
}
```
**参数说明：**

| 参数 | 说明 |
| ------- | ---- |
| errcode |错误码 |
|errmsg|错误码说明|
|status|任务执行状态<br>0: 执行未完成<br>1: 执行完成<br>2: 执行失败|
|analyze_result|批量任务的分析结果，当指定任务中包含“3: 摘要提取”时返回。该结果只可用[会话展示组件](#50920)的 `ww-open-result-text` 模板组件进行展示，详见**BatchResult**|
|analyze_result_list|单条消息分析结果列表，当指定任务中包含“1: 情感分析”或“2: 反垃圾分析”时返回。详见**ItemResult**|

**BatchResult说明**
| 参数 | 说明 |
| ------- | ---- |
|result_id|批量任务的分析结果的临时id，用于传入[会话展示组件](#50920)|
|service_encrypt_info.encrypted_secret_key|加密后的密钥，使用[设置公钥](#51799)设置的公钥进行加密，需要服务商用私钥解密后才可传入[会话展示组件](#50920)|
|service_encrypt_info.public_key_ver|公钥版本号|

**ItemResult说明**
| 参数 | 说明 |
| ------- | ---- |
|msgid|消息对应的msgid|
|sentiment_result|情感分析结果<br>0: 无情感<br>1: 正面<br>2: 负面 |
|spam_result|反垃圾分析结果<br>0: 无违规<br>1: 政治敏感<br>2: 色情|
> 注：
> （1）如果有指定“单条分析”任务，analyze_result_list 列表每次都会将所有会话消息返回，如果有会话消息的分析结果已经获得，则会将其填入结果中，还未获得的则不填。
> （2）“批量分析”任务对于无法参与分析的msgid，也会返回在analyze_result_list 列表中并填入对应的错误码。

## 频率限制说明
- 每企业每天情感分析的消息条数不超过10万条（按消息条数限制，若每次提交分析的消息有1000条，则每天只能提交100次任务。）
- 每企业每天反垃圾分析的消息条数不超过10万条（按消息条数限制，若每次提交分析的消息有1000条，则每天只能提交100次任务。）
- 每企业每天会话摘要的次数不超过1千次（按调用次数限制）
